{{ $currentNode := . }}

{{ range .Site.Menus.main.ByWeight }}

{{ $.Scratch.Set "currentMenuEntry" . }}

<li>
  {{ if in $.Site.Params.custom_menu .Name }}
    {{ partial (.Name | lower | printf "%s") $currentNode }}
  {{ else }}
    {{ partial "nav_link" $currentNode }}
    {{ if .HasChildren }}
    <ul>
      {{ range .Children }}
      {{ $.Scratch.Set "currentMenuEntry" . }}
      {{ partial "nav_link" $currentNode }}
      {{ end }}
    </ul>
    {{ end }}
  {{ end }}
</li>
{{ end }}