---
date: 2016-09-13T09:00:00+00:00
title: Create a workflow to automate events
menu:
  main:
    parent: "Tutorials"
    name: "Create a workflow to automate events"
    weight: 80
draft: true
---

This tutorial will explain how to use the Vamp API and workflows to work with the Vamp events stream. We will create and retrieve some (custom) events using the Vamp REST API, then create a simple workflow to automate this interaction. Let's get started!

### Requirements

* A running version of Vamp 0.9.x (this tutorial has been tested on the [Vamp hello world set up](documentation/installation/hello-world) using Vamp 0.9.1)

## Vamp events
Vamp is a distributed system tied together by a central events stream. Every action in Vamp creates events, which in turn can be measured and used as triggers for new actions. For example, gateway updates are triggered by deployments (synchronisation events), while canary releases and autoscaling are based on health and metrics events. Events are described in the format:  

`['tag', 'tag1:tag2'], value, event_type` 

### Event tags
Each event created by Vamp is given one or more tags. Tags provide meta-information for each stored event and are used for filtering search and for listening. Tags can be either a single tag or a combination of two tags separated by a `:`. The Vamp convention is to use the first tag as a generic label (for example a group) and the second tag as a specific label (i.e. a specific item in a group)

### Event value
The event value is optional and could be anything you choose to store along with an event. Values are not analysed and can't be used for search. If you donâ€™t specify value, it will be blank

### Event types
Vamp works with a number of default event types, custom event types can also be created using the `events` API endpoint (more on that later). If no event type is specified when creating an event, the generic event type `event` will be used. It is advisable to always specify an event type to allow for easy filtering.

Default event types |  Description
----------|--------
Archive     |    Store/update of static Vamp artifacts (breeds, blueprints etc.)
Synchronization | Successful matching of a desired state with an observed state (for example, a successful update from 3 to 5 running instances)
Event | Generic event type, will be used if no event type is specified when creating an event
Health | Generated by the health workflow and used by the Vamp UI
Metrics | Generated by the metrics workflow and used by the Vamp UI
Workflow | Generated by workflows used in Vamp Runner

### Storing events
Vamp events are strored by default in Elasticsearch. Elasticsearch indexing is based on the event type and is updated for each event received by the API. Custom event types will be indexed individually.  
[Read more about events](documentation/using-vamp/events/)

  
## Use the REST API to create events

The `events` endpoint of the Vamp API can be used to create and retrieve events stored in Elasticsearch. We are going to use this endpoint to create an event with the custom type `hello_api`.

Use Postman or curl to `POST` the below JSON to the `/api/v1/events` endpoint.

```
{
  "tags": [
    "tag1:tag2"
  ],
  "value": "optional_value",
  "type": "hello_api"
}
```  
If all runs to plan, you will receive a response from the API with the accepted JSON in the body. You will notice that a timestamp has been added. In Elasticsearch the tag will be expanded, so you will be able to search on the separate tag `tag1` as well as the combined tag `tag1:tag2`. If you check in the Vamp UI, you will see the created event show up in the EVENTS stream at the bottom of the screen.

![](images/screens/v091/events_vampui_hello_api.png)


## Create a simple workflow
Now we know how to generate events with the Vamp API, we can take this a step further and create a simple workflow to automate the process. You can automate Vamp with any application (for example something developed in python), as long as it can count or trigger an action against the Vamp API. For this tutorial, we will create a Vamp workflow. 

Vamp workflows are a convenient way of creating Node JS based scripts that run as containers and access the Vamp API. Workflows run in Vamp workflow agent containers ([github.com/magneticio - Vamp workflow agent](https://github.com/magneticio/vamp-workflow-agent)) and are managed just like any other container inside your cluster, making them robust, scalable and dynamic. A workflows can be scheduled to run as a deamon, be triggered by Vamp events or run at specified timestamp (the Vamp workflow driver is used for time based and event based workflows).

We are going to create a workflow to run as a daemon. We'll start by creating a breed with the required script and then deploy this as a workflow. It is advisable to create a static breed artifact containing the workflow script and reference this from a deployed workflow - once a workflow is undeployed it will disappear, whereas a breed can be deployed any number of times.

### Create a breed 
The breed will hold the JavaScript to be run for our workflow. To be able to interact with Vamp, we will need to include a few items in the JavaScript. The Vamp Node.js Client library allows the note JS application to interact with the Vamp API, see the gitHub project for details ([github.com/magneticio - Vamp Node.js Client](https://github.com/magneticio/vamp-node-client)). We also need to create a new Vamp API object and set a run interval.


  1. Go the BREEDS tab in the Vamp UI
  * Click ADD
  * Paste in the below breed YAML and click SAVE

```
name: hello_workflow
kind: breed
deployable:
  type: application/javascript
  definition: |
    'use strict';

    var vamp = require('vamp-node-client'); // required to interact with the Vamp API

    var api = new vamp.Api(); // a new Vamp API object

    var period = 5;  // milliseconds

    var run = function () {   // create a Vamp event - tag, value, event_type
          api.event('tag1:tag2', 'optional_value', 'hello_workflow'); 
     };

    run();

    setInterval(run, period * 1000); // run this workflow every x seconds
```
![](images/screens/v091/events_vampui_breeds.png)

### Deploy the hello_workflow breed as a workflow
We can now create a workflow that references the `hello_workflow` breed. Once the workflow is created, the breed will be deployed in a Vamp workflow agent container. We will schedule our workflow to run as a daemon, so it will immediately start running at the set interval (5 seconds).

1. Go to the WORKFLOWS tab in the Vamp UI 
* Click ADD (top right)
* Paste in the below workflow YAML and click SAVE

```
name: hello_workflow
kind: workflow
breed: hello_workflow
schedule: daemon
```
The workflow will be deployed and you will see the created events appearing in the Vamp UI EVENTS stream. 

![](images/screens/v091/events_vampui_hello_workflow_5.png)

### Update the running workflow
In Vamp 0.9.1, updates made to a breed will not be carried over to an associated workflow. Vamp breeds are static artifacts, so updating the breed alone will have no effect on the running workflow. To update a running workflow, it must be redeployed (a restart workflow feature is coming very soon). Let's update our running workflow so it runs every second.
 
1. Go the BREEDS tab in the Vamp UI
* Open the `hello_workflow` breed and update the script to set `var period = 1` (this will cause the events to be generated every second)
* Click SAVE
* Check the events stream in the Vamp UI 
  * `hello_workflow` events will continue to appear every 5 seconds
* Go to the WORKFLOWS tab
* Select the `hello_workflow` workflow and delete it. Note that this will only delete the running workflow, not the associated breed. 
* To re-deploy the workflow with the updated breed, click ADD (top right)
* Paste in the same (above) workflow YAML and click SAVE
* Check the events stream again 
  * `hello_workflow` should now be generating events every second - that's a lot of events! Feel free to delete the workflow and stop it running.
 
![](images/screens/v091/events_vampui_hello_workflow_1.png)

## Retrieve and filter events using the REST API
Now we have a lot of events stored we can use the same REST API events endpoint to retrieve them. We can search for specifc events and filter for specific types and tags. You can try this out in Postman or curl by sending a GET request to the `/api/v1/events` endpoint, you can even do this in your browser. Use `?type=` or `?tags=` (`generic` or `generic:specifc`) to search through stored events, it is not currently possible to filter for a specific value. See [using the Vamp API](/documentation/api/using-the-api) for details on pagination.

![](images/screens/v091/events_retrieve_events.png)

The API can also allows be used to retreive an events stream `/api/v1/events/stream`

![](images/screens/v091/events_stream.png)

## Summing up
You should now know a bit more about the Vamp events stream and how it is used by the distributed components of Vamp. Now you understand how to build, deploy and update your own workflows there should be no stopping you - what will you automate?

## Looking for more of a challenge?
Just for fun, you could try these:

* Can you create a workflow that responds to a specific Vamp event?
* The Vamp Node.js Client library also allows you to create workflows that measure and count metrics. how might you incorporate that functionality into an automation workflow? See the gitHub project for details ([github.com/magneticio - Vamp Node.js Client](https://github.com/magneticio/vamp-node-client)) or check the examples used in the Vamp runner recipes ([github.com/magneticio - Vamp Runner recipes](https://github.com/magneticio/vamp-runner/tree/master/recipes))

{{< note title="What next?" >}}
* What would you like to see for our next tutorial? [let us know](mailto:info@magnetic.io)
* Find our more about [using Vamp](documentation/using-vamp/artifacts)
* Read more about the [Vamp API](documentation/api/api-reference)
{{< /note >}}

